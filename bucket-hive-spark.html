<!DOCTYPE html>
<html>
<head>
    
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Bucket in Hive, Spark</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    </script>
<meta name="description" content="Data Engineering" />
    <link rel="shortcut icon" href="https://gyuhoonk.github.io/assets/built/images/favicon.jpg" type="image/png" />
    <link rel="canonical" href="https://gyuhoonk.github.io/bucket-hive-spark" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Gyuhoon Kim" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Bucket in Hive, Spark" />
    <meta property="og:description" content="Hive와 Spark에서 Bucket 차이점에 대하여 Bucketting Bucket은 쿼리 성능 향상을 위해 사용됩니다. 특히 Join에서 사용되는 key column을 기준으로 bucketting 할 경우 큰 성능 향상을 얻을 수 있습니다. Bucket의 기본 아이디어는 지정된 칼럼을 기준으로 hash function을 통해 만들어진 값에 해당하는 bucket file에 데이터를 저장하는 것입니다. Bucket in Hive HiveQL로 Partition, Bucket이" />
    <meta property="og:url" content="https://gyuhoonk.github.io/bucket-hive-spark" />
    <meta property="og:image" content="https://gyuhoonk.github.io/assets/built/images/bucket-banner.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2021-10-09T22:30:00+09:00" />
    <meta property="article:modified_time" content="2021-10-09T22:30:00+09:00" />
    <meta property="article:tag" content="Hadoop" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Bucket in Hive, Spark" />
    <meta name="twitter:description" content="Hive와 Spark에서 Bucket 차이점에 대하여 Bucketting Bucket은 쿼리 성능 향상을 위해 사용됩니다. 특히 Join에서 사용되는 key column을 기준으로 bucketting 할 경우 큰 성능 향상을 얻을 수 있습니다. Bucket의 기본 아이디어는 지정된 칼럼을 기준으로 hash function을 통해 만들어진 값에 해당하는 bucket file에 데이터를 저장하는 것입니다. Bucket in Hive HiveQL로 Partition, Bucket이" />
    <meta name="twitter:url" content="https://gyuhoonk.github.io/" />
    <meta name="twitter:image" content="https://gyuhoonk.github.io/assets/built/images/bucket-banner.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Gyuhoon Kim" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Hadoop" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Gyuhoon Kim",
        "logo": "https://gyuhoonk.github.io/"
    },
    "url": "https://gyuhoonk.github.io/bucket-hive-spark",
    "image": {
        "@type": "ImageObject",
        "url": "https://gyuhoonk.github.io/assets/built/images/bucket-banner.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://gyuhoonk.github.io/bucket-hive-spark"
    },
    "description": "Hive와 Spark에서 Bucket 차이점에 대하여 Bucketting Bucket은 쿼리 성능 향상을 위해 사용됩니다. 특히 Join에서 사용되는 key column을 기준으로 bucketting 할 경우 큰 성능 향상을 얻을 수 있습니다. Bucket의 기본 아이디어는 지정된 칼럼을 기준으로 hash function을 통해 만들어진 값에 해당하는 bucket file에 데이터를 저장하는 것입니다. Bucket in Hive HiveQL로 Partition, Bucket이"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Bucket in Hive, Spark" href="/feed.xml" />

    
</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://gyuhoonk.github.io/">Gyuhoon Kim</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem">
        <a href="/about/">About</a>
    </li>
    <li class="nav-python" role="menuitem">
        <a href="/tag/python/">python</a>
    </li>
    <li class="nav-scala" role="menuitem">
        <a href="/tag/scala/">scala</a>
    </li>
    <li class="nav-hadoop" role="menuitem">
        <a href="/tag/hadoop/">hadoop</a>
    </li>
    <li class="nav-database" role="menuitem">
        <a href="/tag/database/">database</a>
    </li>
    <li class="nav-database" role="menuitem">
        <a href="/tag/kubernetes/">kubernetes</a>
    </li>
    <li class="nav-archive" role="menuitem">
        <a href="/archive.html">All Posts</a>
    </li>
    <li class="nav-archive" role="menuitem">
        <a href="/author_archive.html">Tag</a>
    </li>
</ul>
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
        </div>
        
            <a class="subscribe-button" href="#subscribe">Subscribe</a>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-hadoop post tag-hadoop ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime=" 9 October 2021"> 9 October 2021</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/hadoop/'>HADOOP</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Bucket in Hive, Spark</h1>
            </header>

            <!-- 
            <figure class="post-full-image" style="background-image: url(/assets/built/images/bucket-banner.jpg)">
            </figure>
             -->

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Hive와 Spark에서 Bucket 차이점에 대하여</p>

<h1 id="bucketting">Bucketting</h1>

<p>Bucket은 쿼리 성능 향상을 위해 사용됩니다. 특히 Join에서 사용되는 key column을 기준으로 bucketting 할 경우 큰 성능 향상을 얻을 수 있습니다.</p>

<p>Bucket의 기본 아이디어는 지정된 칼럼을 기준으로 hash function을 통해 만들어진 값에 해당하는 bucket file에 데이터를 저장하는 것입니다.</p>

<p><img src="../../assets/built/images/bucketing-in-hive.png" alt="image" /></p>

<h1 id="bucket-in-hive">Bucket in Hive</h1>

<p>HiveQL로 Partition, Bucket이 선언된 테이블을 선언하는 쿼리는 아래와 같습니다.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="n">bucketed_tbl</span> <span class="c1">-- EXTERNAL TABLE로 생성</span>
<span class="p">(</span><span class="n">name</span> <span class="n">string</span><span class="p">,</span> <span class="n">birthday</span> <span class="nb">timestamp</span><span class="p">)</span> <span class="c1">-- COLUMN을 선언, PARTITION으로 사용되는 COLUMN은 제외함</span>
<span class="n">PARTITIONED</span> <span class="k">BY</span> <span class="p">(</span><span class="n">p_date</span> <span class="n">string</span><span class="p">)</span> <span class="c1">-- PARTITION 기준 선언</span>
<span class="n">CLUSTERED</span> <span class="k">BY</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="c1">-- HASH FUNCTION에 사용할 기준 선언</span>
	<span class="n">SORTED</span> <span class="k">BY</span> <span class="p">(</span><span class="n">birthday</span><span class="p">)</span> <span class="c1">-- BUCKET 내에서 정렬 기준 선언</span>
	<span class="k">INTO</span> <span class="mi">32</span> <span class="n">BUEKCTS</span> <span class="c1">-- BUCKET FILE 개수 선언</span>
<span class="n">STORED</span> <span class="k">AS</span> <span class="s1">'parquet'</span>
<span class="k">LOCATION</span> <span class="s1">'/user/hive/warehouse/default.db/bucketed_tbl'</span> <span class="c1">-- EXTERNAL TABLE의 저장 위치</span>
<span class="p">;</span>
</code></pre></div></div>

<p>해당 테이블에 INSERT는 아래와 같은 쿼리로 실행합니다(STATIC PARTITION).</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">TABLE</span> <span class="n">buckted_tbl</span> <span class="n">PARTITION</span> <span class="p">(</span><span class="n">p_date</span><span class="o">=</span><span class="s1">'20211010'</span><span class="p">)</span>
<span class="k">SELECT</span> 
	<span class="n">name</span><span class="p">,</span> <span class="n">birthday</span>
<span class="k">FROM</span> <span class="mi">20211010</span><span class="n">_source</span>
</code></pre></div></div>

<p>INSERT 이후 LOCATION에는 아래처럼 파일이 저장됩니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>gyuhoonk@namenode1~]<span class="nv">$ </span>hdfs dfs <span class="nt">-ls</span> /user/hive/warehouse/default.db/bucketed_tbl
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_0
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_1
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_2
...
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_31
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">p_date=20211010</code> partition을 한번 더 INSERT하면, <code class="language-plaintext highlighter-rouge">_copy1</code>이 붙은 bucket file들이 저장됩니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>gyuhoonk@namenode1~]<span class="nv">$ </span>hdfs dfs <span class="nt">-ls</span> /user/hive/warehouse/default.db/bucketed_tbl
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_0
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_0_copy_1
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_1
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_1_copy_1
...
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_31
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/000000_31_copy_1
</code></pre></div></div>

<h1 id="bucket-in-sparkpyspark">Bucket in Spark(pyspark)</h1>

<p>Spark에서도 partition, bucket 기능을 제공합니다. 위에서 실행했던 HiveQL 쿼리는 아래 pyspark 코드와 같은 표면적으로는 같은 의미를 지닙니다. 즉 HiveQL이나 아래 pyspark 코드는 모두 1) External 2) Partition 3) Bucket 을 선언하고 있습니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">"SELECT * FROM 20211010_soucre"</span><span class="p">)</span>
<span class="n">source</span><span class="p">.</span><span class="n">write</span>\
      <span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">'parquet'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s">'p_date'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">bucketBy</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">'name'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">sortBy</span><span class="p">(</span><span class="s">'birthday'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">mode</span><span class="p">(</span><span class="s">'append'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'path'</span><span class="p">,</span> <span class="s">'/user/hive/warehouse/default.db/buckted_tbl'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s">'default.bucketed_tbl'</span><span class="p">)</span>
</code></pre></div></div>

<p>32개의 bucket 파일이 생성될 것 같지만, 이렇게 저장한 경우에 매우 많은 parquet file이 생성된다는 겁니다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Bucket in Hive에서 저장된 파일들은 모두 삭제했다고 가정하고 조회</span>
<span class="o">[</span>gyuhoonk@namenode1~]<span class="nv">$ </span>hdfs dfs <span class="nt">-ls</span> /user/hive/warehouse/default.db/bucketed_tbl
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/part-000000-xxxx-xxxx.parquet
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/part-000001-xxxx-xxxx.parquet
...
/user/hive/warehouse/default.db/bucketed_tbl/p_date<span class="o">=</span>20211010/part-012415-xxxx-xxxx.parquet
<span class="c"># 12416개의 bucket file</span>
</code></pre></div></div>

<p>왜 이렇게 많은 bucket들이 생성되는 것일까요?</p>

<p>이는 spark에서 bucketting을 할 경우 각 MAP 별로 bucekt file을 만들기 때문입니다.</p>

<p><img src="../../assets/built/images/hive-spark-bucket.png" alt="image" /></p>

<p>위 그림처럼, Hive에서는 Reducer 하나가 하나의 bucket을 만드는데 비해, Spark에서는 각 task가 자신의 bucket을 만들고 이를 테이블 경로(<code class="language-plaintext highlighter-rouge">path</code>)에 저장합니다.</p>

<p>계산해보면 \(32 * 388 = 12416\)입니다. 즉, 388개의 task가 각각 bucket file을 생성하였기 때문에 위와 같이 12416개의 bucket file이 저장된 것입니다. 따라서 Spark를 통해 bucketting을 할 때는 이러한 부분에 주의해야합니다.</p>

<h1 id="hive-bucket-vs-spark-bucket">Hive Bucket vs. Spark Bucket</h1>

<p>더 큰 문제는 Hive Bucket과 Spark Bucket이 양립할 수 없다는 것입니다.</p>

<h2 id="spark를-통해-생성된-bucketed-table은-hive에서-조회-불가능하다">Spark를 통해 생성된 Bucketed Table은 Hive에서 조회 불가능하다</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">"SELECT * FROM 20211010_soucre"</span><span class="p">)</span>
<span class="n">source</span><span class="p">.</span><span class="n">write</span>\
      <span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">'parquet'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s">'p_date'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">bucketBy</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">'name'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">sortBy</span><span class="p">(</span><span class="s">'birthday'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">mode</span><span class="p">(</span><span class="s">'append'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'path'</span><span class="p">,</span> <span class="s">'/user/hive/warehouse/default.db/buckted_tbl'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s">'default.bucketed_tbl'</span><span class="p">)</span>
</code></pre></div></div>

<p>pyspark로 위와 같이 적재에 성공하더라도, 테이블을 조회하는 쿼리를 실행할 경우 에러를 발생시킵니다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>gyuhoonk@namenode1~]<span class="nv">$ </span>hive <span class="nt">-e</span> <span class="s2">"SELECT * FROM default.bucketed_tbl"</span>
<span class="c"># Error</span>
</code></pre></div></div>

<h2 id="hiveql로-생성된-bucketed-table에는-spark를-통해-insert할-수-없다">HiveQL로 생성된 Bucketed Table에는 Spark를 통해 INSERT할 수 없다</h2>

<ol>
  <li>
    <p>먼저 Bucketed Table을 생성하는 아래 쿼리를 실행합니다.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="n">bucketed_tbl</span> <span class="c1">-- EXTERNAL TABLE로 생성</span>
<span class="p">(</span><span class="n">name</span> <span class="n">string</span><span class="p">,</span> <span class="n">birthday</span> <span class="nb">timestamp</span><span class="p">)</span> <span class="c1">-- COLUMN을 선언, PARTITION으로 사용되는 COLUMN은 제외함</span>
<span class="n">PARTITIONED</span> <span class="k">BY</span> <span class="p">(</span><span class="n">p_date</span> <span class="n">string</span><span class="p">)</span> <span class="c1">-- PARTITION 기준 선언</span>
<span class="n">CLUSTERED</span> <span class="k">BY</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="c1">-- HASH FUNCTION에 사용할 기준 선언</span>
	<span class="n">SORTED</span> <span class="k">BY</span> <span class="p">(</span><span class="n">birthday</span><span class="p">)</span> <span class="c1">-- BUCKET 내에서 정렬 기준 선언</span>
	<span class="k">INTO</span> <span class="mi">32</span> <span class="n">BUEKCTS</span> <span class="c1">-- BUCKET FILE 개수 선언</span>
<span class="n">STORED</span> <span class="k">AS</span> <span class="s1">'parquet'</span>
<span class="k">LOCATION</span> <span class="s1">'/user/hive/warehouse/default.db/bucketed_tbl'</span> <span class="c1">-- EXTERNAL TABLE의 저장 위치</span>
<span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>pyspark를 이용하여 Bucketed Table에 데이터를 append(INSERT)합니다.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">"SELECT * FROM 20211010_soucre"</span><span class="p">)</span>
<span class="n">source</span><span class="p">.</span><span class="n">write</span>\
      <span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">'parquet'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s">'p_date'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">bucketBy</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">'name'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">sortBy</span><span class="p">(</span><span class="s">'birthday'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">mode</span><span class="p">(</span><span class="s">'append'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'path'</span><span class="p">,</span> <span class="s">'/user/hive/warehouse/default.db/buckted_tbl'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s">'default.bucketed_tbl'</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>아래와 같은 에러 메시지를 확인할 수 있습니다.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The format of the existing table default.bucketed_tbl is 'HiveFormat'.
It doesn't match the specified format 'ParquetFileFormat'.
</code></pre></div>    </div>

    <p>HiveQL로 생성한 Bucketed Table은 <code class="language-plaintext highlighter-rouge">HiveFormat</code>으로 저장되어 있어 <code class="language-plaintext highlighter-rouge">ParquetFileFormat</code> 으로 파일을 적재할 수 없다는 메시지입니다.</p>
  </li>
  <li>
    <p>이번에는 <code class="language-plaintext highlighter-rouge">HiveFormat</code>으로 적재해보았습니다.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">"SELECT * FROM 20211010_soucre"</span><span class="p">)</span>
<span class="n">source</span><span class="p">.</span><span class="n">write</span>\
      <span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">'hive'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s">'p_date'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">bucketBy</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">'name'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">sortBy</span><span class="p">(</span><span class="s">'birthday'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">mode</span><span class="p">(</span><span class="s">'append'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'path'</span><span class="p">,</span> <span class="s">'/user/hive/warehouse/default.db/buckted_tbl'</span><span class="p">)</span>\
      <span class="p">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s">'default.bucketed_tbl'</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>이번에는 다른 에러 메시지가 확인됩니다.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Creating buckted Hive Serde table is not supported yet.
</code></pre></div>    </div>

    <p>Spark가 아직 <code class="language-plaintext highlighter-rouge">Bucketed Hive Serde</code>를 생성하는 기능을 지원하지 않고 있다는 내용입니다. 제가 테스트에 사용했던 spark 버전은 <strong>2.3</strong>입니다.</p>

    <p>현재는 3.0 이상의 버전이 릴리즈된 것으로 알고 있는데 현재 이 기능이 구현되었는지는 확인해보아야할 것 같습니다.</p>
  </li>
</ol>

<p>[참고]</p>

<p><a href="https://medium.com/analytics-vidhya/spark-bucketing-is-not-as-simple-as-it-looks-c74f105f4af0">Spark Bucketing is not as simple as it looks</a></p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            <!-- 
                <section class="subscribe-form">
                    <h3 class="subscribe-form-title">Subscribe to Gyuhoon Kim</h3>
                    <p>Get the latest posts delivered right to your inbox</p>
                    <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

                </section>
             -->

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/built/images/GyuhoonK.jpg" alt="GyuhoonK" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/GyuhoonK">GyuhoonK</a></h4>
                                
                                    <p>Read <a href="/author/GyuhoonK">more posts</a> by this author.</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/GyuhoonK">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            <!--  -->
            <!-- utteranc setting -->
            <script src="https://utteranc.es/client.js"
                    repo="GyuhoonK/blog-comments"
                    issue-term="pathname"
                    theme="github-light"
                    crossorigin="anonymous"
                    async>
            </script>

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/built/images/spain-blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Gyuhoon Kim &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/hadoop/">Hadoop</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/spark-salting">Salting in Spark</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/non-deterministic-udf">non-deterministic UDF</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/impala-with-clause">WITH절/VIEW 사용 시 쿼리 플랜에 대해서</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/hadoop/">
                                
                                    See all 12 posts  →
                                
                            </a>
                        </footer>
                    </article>
                <script type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
                </script>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/hive-merge-query">
                <div class="post-card-image" style="background-image: url(/assets/built/images/merge-files.svg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/hive-merge-query">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Hadoop</span>
                            
                        
                    

                    <h2 class="post-card-title">Merge Files in HDFS</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>HDFS에서 작은 용량의 파일들을 합쳐보자

</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/built/images/GyuhoonK.jpg" alt="GyuhoonK" />
                        
                        <span class="post-card-author">
                            <a href="/author/GyuhoonK/">GyuhoonK</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      5 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/gaussian_kernel">
                <div class="post-card-image" style="background-image: url(/assets/built/images/gaussian-kernel-formula.jpeg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/gaussian_kernel">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Datascience</span>
                            
                        
                    

                    <h2 class="post-card-title">Gaussian Kernel</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>Gaussian Kernel(RBF) 기본 개념에 대하여

</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/built/images/GyuhoonK.jpg" alt="GyuhoonK" />
                        
                        <span class="post-card-author">
                            <a href="/author/GyuhoonK/">GyuhoonK</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      2 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://gyuhoonk.github.io/">
            
            <span>Gyuhoon Kim</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Bucket in Hive, Spark</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Bucket+in+Hive%2C+Spark&amp;url=https://gyuhoonk.github.iobucket-hive-spark"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://gyuhoonk.github.iobucket-hive-spark"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://gyuhoonk.github.io/">Gyuhoon Kim</a> &copy; 2023</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyllt/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    
        <div id="subscribe" class="subscribe-overlay">
            <a class="subscribe-overlay-close" href="#"></a>
            <div class="subscribe-overlay-content">
                
                <h1 class="subscribe-overlay-title">Subscribe to Gyuhoon Kim</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest &amp; greatest posts delivered straight to your inbox</p>
                <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

            </div>
        </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-xxxxxxxx-x', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
<script type="text/javascript" async
	src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>

<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
	extensions: ["tex2jax.js"],
	jax: ["input/TeX", "output/HTML-CSS"],
	tex2jax: {
		inlineMath: [ ['$','$'], ["\\(","\\)"] ],
		displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
		processEscapes: true
	},
	"HTML-CSS": { availableFonts: ["TeX"] }
});
</script>
    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->
    <!-- math LaTex-->
    
</body>
</html>
