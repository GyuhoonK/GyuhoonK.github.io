<!DOCTYPE html>
<html>
<head>
    
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Salting in Spark</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    </script>
<meta name="description" content="Data Engineering" />
    <link rel="shortcut icon" href="https://gyuhoonk.github.io/assets/built/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://gyuhoonk.github.io/spark-salting" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Gyuhoon Kim" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Salting in Spark" />
    <meta property="og:description" content="Data Skewness를 해결하는 Spark Salting Key 기법에 대해서 알아봅니다. What is Salting in Spark? 요리를 할 때 소금을 뿌림으로써 재료의 맛과 향을 더해줄 수 있습니다. spark의 salting 기법도 요리에서 소금을 뿌리는 것과 비슷합니다. 데이터가 더 잘 처리될 수 있도록 도와주는 역할을 합니다. salting이란 spark에서 shuffle join하는 경우에 발생할 수 있는" />
    <meta property="og:url" content="https://gyuhoonk.github.io/spark-salting" />
    <meta property="og:image" content="https://gyuhoonk.github.io/assets/built/images/hadoop/salting.jpeg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2023-12-30T22:30:00+09:00" />
    <meta property="article:modified_time" content="2023-12-30T22:30:00+09:00" />
    <meta property="article:tag" content="Hadoop" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Salting in Spark" />
    <meta name="twitter:description" content="Data Skewness를 해결하는 Spark Salting Key 기법에 대해서 알아봅니다. What is Salting in Spark? 요리를 할 때 소금을 뿌림으로써 재료의 맛과 향을 더해줄 수 있습니다. spark의 salting 기법도 요리에서 소금을 뿌리는 것과 비슷합니다. 데이터가 더 잘 처리될 수 있도록 도와주는 역할을 합니다. salting이란 spark에서 shuffle join하는 경우에 발생할 수 있는" />
    <meta name="twitter:url" content="https://gyuhoonk.github.io/" />
    <meta name="twitter:image" content="https://gyuhoonk.github.io/assets/built/images/hadoop/salting.jpeg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Gyuhoon Kim" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Hadoop" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Gyuhoon Kim",
        "logo": "https://gyuhoonk.github.io/"
    },
    "url": "https://gyuhoonk.github.io/spark-salting",
    "image": {
        "@type": "ImageObject",
        "url": "https://gyuhoonk.github.io/assets/built/images/hadoop/salting.jpeg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://gyuhoonk.github.io/spark-salting"
    },
    "description": "Data Skewness를 해결하는 Spark Salting Key 기법에 대해서 알아봅니다. What is Salting in Spark? 요리를 할 때 소금을 뿌림으로써 재료의 맛과 향을 더해줄 수 있습니다. spark의 salting 기법도 요리에서 소금을 뿌리는 것과 비슷합니다. 데이터가 더 잘 처리될 수 있도록 도와주는 역할을 합니다. salting이란 spark에서 shuffle join하는 경우에 발생할 수 있는"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Salting in Spark" href="/feed.xml" />

    
</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://gyuhoonk.github.io/">Gyuhoon Kim</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem">
        <a href="/about/">About</a>
    </li>
    <li class="nav-python" role="menuitem">
        <a href="/tag/python/">python</a>
    </li>
    <li class="nav-scala" role="menuitem">
        <a href="/tag/scala/">scala</a>
    </li>
    <li class="nav-hadoop" role="menuitem">
        <a href="/tag/hadoop/">hadoop</a>
    </li>
    <li class="nav-database" role="menuitem">
        <a href="/tag/database/">database</a>
    </li>
    <li class="nav-database" role="menuitem">
        <a href="/tag/kubernetes/">kubernetes</a>
    </li>
    <li class="nav-archive" role="menuitem">
        <a href="/archive.html">All Posts</a>
    </li>
    <li class="nav-archive" role="menuitem">
        <a href="/author_archive.html">Tag</a>
    </li>
</ul>
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
        </div>
        
            <a class="subscribe-button" href="#subscribe">Subscribe</a>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-hadoop post tag-hadoop ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="30 December 2023">30 December 2023</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/hadoop/'>HADOOP</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Salting in Spark</h1>
            </header>

            <!-- 
            <figure class="post-full-image" style="background-image: url(/assets/built/images/hadoop/salting.jpeg)">
            </figure>
             -->

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Data Skewness를 해결하는 Spark Salting Key 기법에 대해서 알아봅니다.</p>

<h3 id="what-is-salting-in-spark">What is Salting in Spark?</h3>

<p>요리를 할 때 소금을 뿌림으로써 재료의 맛과 향을 더해줄 수 있습니다. spark의 salting 기법도 요리에서 소금을 뿌리는 것과 비슷합니다. 데이터가 더 잘 처리될 수 있도록 도와주는 역할을 합니다.</p>

<p>salting이란 spark에서 shuffle join하는 경우에 발생할 수 있는 데이터 불균형(skewness)을 해결하기 위해 사용되는 기법입니다.</p>

<p>Spark에서 skewness는 성능 저하를 유발합니다.</p>
<ul>
  <li>
    <p>bottle neck<br />
skewness가 있는 경우 spark job 완료까지 소요되는 시간(가동 시간, Total uptime)이 늘어납니다. spark job에서 10개의 task를 처리할 때, 9개의 task는 10초만에 완료하더라도 1개 task의 처리에 100초가 소요된다면 전체 spark job의 total uptime은 100초입니다. skewness가 발생하는 경우 앞선 예시처럼 skewness가 있는 데이터를 처리하는 task의 수행시간이 다른 task에 비해 늘어나게 되고, 전체 spark job의 uptime을 증가시키는 bottle neck을 유발합니다.</p>
  </li>
  <li>
    <p>job fail<br />
skewness는 spark job의 실패를 초래할 수도 있습니다. 특정 task가 처리해야할 데이터가 할당받은 리소스의 처리 능력을 넘는다면 task fail이 발생하게 되고 이는 spark job의 실패로 이어질 수도 있습니다.</p>
  </li>
</ul>

<p>salting 기법은 새로운 JOIN KEY(SALTING KEY)를 추가하여 skewness를 해결합니다. salting key를 기준으로 데이터가 한번 더 분산되기 때문에, join 연산 간에 특정 파티션에만 데이터가 쏠리는 현상을 방지할 수 있습니다.</p>

<h3 id="example">Example</h3>

<p>구체적인 예시로 salting key 기법이 적용되는 과정을 설명해보겠습니다.</p>

<p>먼저 skewness가 발생할 수 있는 상황을 가정해보겠습니다.</p>

<p><img src="../../assets/built/images/hadoop/salting_example_1.png" alt="image" /></p>

<p><code class="language-plaintext highlighter-rouge">log</code>와 <code class="language-plaintext highlighter-rouge">user_type</code> 이라는 DataFrame이 존재한다고 가정했습니다. <code class="language-plaintext highlighter-rouge">log</code>에 각 유저(<code class="language-plaintext highlighter-rouge">user_id</code>)의 type을 추가하려면 아래와 같이 코드를 작성하면 됩니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">joined</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_type</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'user_id'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
</code></pre></div></div>

<p>type 컬럼을 추가하고려는 목적은 달성할 수 있으나 위와 같은 경우에 data skewness가 발생합니다. <code class="language-plaintext highlighter-rouge">user_id</code>가 <code class="language-plaintext highlighter-rouge">e</code>인 경우에 해당하는 row가 6개입니다. 따라서, <code class="language-plaintext highlighter-rouge">user_id</code>만을 가지고 join하는 경우 <code class="language-plaintext highlighter-rouge">e</code>를 처리하는 파티션 사이즈가 다른 파티션(<code class="language-plaintext highlighter-rouge">a~d</code>를 처리하는 파티션)에 비해 커지게 됩니다.<br />
상대적으로 비교했을 때, <code class="language-plaintext highlighter-rouge">a~d</code>를 처리하는 파티션 사이즈가 1인 것에 비해 <code class="language-plaintext highlighter-rouge">e</code>를 처리하는 파티션 사이즈는 6이므로 해당 파티션 처리는 다른 파티션에 비해 6배의 시간이 소요될 것입니다.</p>

<p><img src="../../assets/built/images/hadoop/salting_example_2.png" alt="image" /></p>

<p>위와 같은 상황에서 발생한 skewness를 해결하기 위해 salting key를 적용해봅시다. 일단 모든 파티션 사이즈가 1로 동일하길 희망합니다. 이를 위해 salting key를 추가하고 <code class="language-plaintext highlighter-rouge">user_type</code> DataFrame의 row를 복제합니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">rand</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">explode</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">IntegerType</span>

<span class="n">SALTING_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1"># log에 salting key 추가 / 0~9 사이의 무작위 정수값 추가
</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"salting_key"</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">salt_size</span><span class="p">()).</span><span class="n">cast</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">())</span>
                     <span class="p">)</span>

<span class="c1"># user_type에 salting key를 추가, 모든 row가 0~9의 값을 갖게됨
</span><span class="n">user_type</span> <span class="o">=</span> <span class="n">user_type</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"salting_key"</span><span class="p">,</span>
                                 <span class="n">explode</span><span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SALTING_SIZE</span><span class="p">)]))</span>
                                 <span class="p">)</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_type</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">'user_id'</span><span class="p">,</span> <span class="s">'salting_key'</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">user_id</code>와 <code class="language-plaintext highlighter-rouge">salting_key</code>를 기준으로 join하므로 <code class="language-plaintext highlighter-rouge">log</code>의 각 row는 <code class="language-plaintext highlighter-rouge">user_type</code>의 1개 row와만 매칭됩니다. 따라서 모든 경우에 대해서 파티션 사이즈가 1로 매핑됩니다.</p>

<p><img src="../../assets/built/images/hadoop/salting_example_3.png" alt="image" /></p>

<h3 id="optimization">Optimization</h3>

<p>salting key를 적용하면 data skewness를 해결할 수 있음을 확인했습니다. 하지만 위의 예시에서는 아직 문제점이 존재합니다. <code class="language-plaintext highlighter-rouge">user_type</code>은 salting key를 추가하는 과정에서 그 데이터 사이즈가 10배 커졌습니다.</p>

<p>이 글에서 예시로 작성한 경우는 데이터셋이 매우 작으므로 문제가 되지 않지만, 실제 데이터를 가공하는 경우에는 특정 데이터셋을 10배로 키우는 것은 문제가 될 수 있습니다(아니, 대부분 문제가 됩니다).</p>

<p>이를 최적화하기 위해서는 어떻게 접근해야할까요?</p>

<h4 id="접근1-salting_size를-조정한다">[접근1] <code class="language-plaintext highlighter-rouge">SALTING_SIZE</code>를 조정한다</h4>

<p><code class="language-plaintext highlighter-rouge">SALTING_SIZE</code>를 8로 줄이면, 데이터 사이즈를 10배 증가하던 것을 8배 증가로 줄일 수 있습니다. 또한 <code class="language-plaintext highlighter-rouge">log</code> 데이터의 모든 rows에 대해서 join이 되는 것도 보장할 수 있습니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SALTING_SIZE</span> <span class="o">=</span> <span class="mi">8</span>
</code></pre></div></div>
<p>그러나 여전히 데이터가 8배가 되는 것은 부담이 됩니다. 또한 데이터를 직접 확인해보지 않으면 파라미터(SALING_SIZE)를 어떤 값으로 설정해야하는지 판단할 수 없습니다.</p>

<h4 id="접근2-동적으로-salting_size를-결정한다">[접근2] 동적으로 SALTING_SIZE를 결정한다</h4>

<p>로직을 추가하여 <code class="language-plaintext highlighter-rouge">user_type</code>을 복제할 사이즈를 자동으로 결정할 수 있습니다. 이 과정에서 <code class="language-plaintext highlighter-rouge">user_type</code> 전체를 복제하는 것이 아니라 <code class="language-plaintext highlighter-rouge">user_id</code> 별로 얼마나 복제해야할지 동적으로 결정한다면 메모리를 훨씬 더 아낄 수 있습니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">rand</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">explode</span><span class="p">,</span> <span class="n">udf</span><span class="p">,</span> <span class="n">col</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">ArrayType</span>

<span class="n">user_id_cnt</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s">'user_id'</span><span class="p">).</span><span class="n">count</span><span class="p">()</span>

<span class="c1"># log
</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_id_cnt</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'user_id'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"salting_key"</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">col</span><span class="p">(</span><span class="s">"count"</span><span class="p">)).</span><span class="n">cast</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">())</span>
                     <span class="p">)</span>

<span class="o">@</span><span class="n">udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">IntergerType</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">get_salting_array</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="s">'''
    count=3 =&gt; [0, 1, 2]
    '''</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>

<span class="c1"># user_type
</span><span class="n">user_type</span> <span class="o">=</span> <span class="n">user_type</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_id_cnt</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'user_id'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">user_type</span> <span class="o">=</span> <span class="n">user_type</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"salting_key"</span><span class="p">,</span>
                                 <span class="n">explode</span><span class="p">(</span><span class="n">get_salting_array</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">"count"</span><span class="p">)))</span>
                                 <span class="p">)</span>

<span class="n">joined</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_type</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">'user_id'</span><span class="p">,</span> <span class="s">'salting_key'</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">user_id_cnt</code>에 따라 결정된 salting_size는 아래와 같습니다. 따라서 <code class="language-plaintext highlighter-rouge">user_type</code>에서 <code class="language-plaintext highlighter-rouge">(e, GENERAL)</code>에 해당하는 row만 salting_key 0~5를 부여하여 6개로 복제됩니다.</p>

<p><img src="../../assets/built/images/hadoop/salting_example_4.png" alt="image" /></p>

<p>여기서 <code class="language-plaintext highlighter-rouge">user_type</code>의 복제를 더 최소화할 수 있는 마지막 접근법이 있습니다.</p>

<h4 id="접근3-join을-11-매핑에서-1n이-가능하도록-수정한다">[접근3] join을 1:1 매핑에서 1:N이 가능하도록 수정한다</h4>
<p>1:N 매핑이 가능하도록 로직을 수정하면, 접근2의 결과보다도 복제를 더 최소화할 수 있습니다.</p>

<p><code class="language-plaintext highlighter-rouge">user_id=e</code>인 경우에 집중해봅시다. 현재 상태에서 join을 하게되면 1 task가 1 row를 처리합니다(<code class="language-plaintext highlighter-rouge">1row/task</code>). 대신 <code class="language-plaintext highlighter-rouge">user_type</code>에는 6 rows를 복제해야했습니다.</p>

<p>그렇다면, 1 task가 2 rows씩 처리(<code class="language-plaintext highlighter-rouge">2rows/task</code>)하도록 한다면 복제해야하는 사이즈를 줄일 수 있지 않을까요?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">rand</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">explode</span><span class="p">,</span> <span class="n">udf</span><span class="p">,</span> <span class="n">col</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">ArrayType</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>

<span class="n">PARTITION_SIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># 1개 task가 처리할 rows 개수
</span>
<span class="n">user_id_cnt</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s">'user_id'</span><span class="p">).</span><span class="n">count</span><span class="p">()</span>

<span class="o">@</span><span class="n">udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="n">IntegerType</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">get_salting_size</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="s">'''
    count=6 =&gt; ceil(6/2)
    count=1 =&gt; ceil(1/2)
    '''</span>
    <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">ceil</span><span class="p">(</span><span class="n">count</span><span class="o">/</span><span class="n">PARTITION_SIZE</span><span class="p">)</span>

<span class="o">@</span><span class="n">udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">IntergerType</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">get_salting_array</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="s">'''
    count=3 =&gt; [0, 1, 2]
    '''</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>

<span class="c1"># log
</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_id_cnt</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'user_id'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"salting_size"</span><span class="p">,</span> <span class="n">get_salting_size</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">'count'</span><span class="p">)))</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"salting_key"</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">col</span><span class="p">(</span><span class="s">"salting_size"</span><span class="p">)).</span><span class="n">cast</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">())</span>
                     <span class="p">)</span>

<span class="c1"># user_type
</span><span class="n">user_type</span> <span class="o">=</span> <span class="n">user_type</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_id_cnt</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'user_id'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"salting_size"</span><span class="p">,</span> <span class="n">get_salting_size</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">'count'</span><span class="p">)))</span>
<span class="n">user_type</span> <span class="o">=</span> <span class="n">user_type</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"salting_key"</span><span class="p">,</span>
                                 <span class="n">explode</span><span class="p">(</span><span class="n">get_salting_array</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">"salting_size"</span><span class="p">)))</span>
                                 <span class="p">)</span>

<span class="n">joined</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_type</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">'user_id'</span><span class="p">,</span> <span class="s">'salting_key'</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">get_salting_size</code>에 의해 <code class="language-plaintext highlighter-rouge">user_id</code>의 count 수를 그대로 salting_size로 사용하는 것이 아니라 연산을 거칩니다. <code class="language-plaintext highlighter-rouge">PARTITION_SIZE</code>란 하나의 task가 처리할 row 수를 의미합니다. 따라서 <code class="language-plaintext highlighter-rouge">user_id=e</code>의 경우 2 rows씩 처리하면 되므로 3 rows만 복제했습니다.</p>

<p><img src="../../assets/built/images/hadoop/salting_example_5.png" alt="image" /></p>

<h3 id="conclusion">Conclusion</h3>
<ul>
  <li>spark에서 data skewness를 줄이기 위해 salting key 기법을 사용할 수 있다</li>
  <li>salting key 사용 시 데이터 복제가 발생한다</li>
  <li>동적으로 salting size를 결정하도록 코드를 구현하여 데이터 복제를 최소화할 수 있다</li>
</ul>

<p>[참고]<br />
<a href="https://mesh.dev/20220130-dev-notes-008-salting-method-and-examples/">[VROONG 테크 블로그]Salting 기법 예제 코드</a></p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            <!-- 
                <section class="subscribe-form">
                    <h3 class="subscribe-form-title">Subscribe to Gyuhoon Kim</h3>
                    <p>Get the latest posts delivered right to your inbox</p>
                    <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

                </section>
             -->

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/built/images/GyuhoonK.jpg" alt="GyuhoonK" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/GyuhoonK">GyuhoonK</a></h4>
                                
                                    <p>Read <a href="/author/GyuhoonK">more posts</a> by this author.</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/GyuhoonK">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            <!--  -->
            <!-- utteranc setting -->
            <script src="https://utteranc.es/client.js"
                    repo="GyuhoonK/blog-comments"
                    issue-term="pathname"
                    theme="github-light"
                    crossorigin="anonymous"
                    async>
            </script>

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/built/images/spain-blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Gyuhoon Kim &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/hadoop/">Hadoop</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/non-deterministic-udf">non-deterministic UDF</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/impala-with-clause">WITH절/VIEW 사용 시 쿼리 플랜에 대해서</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/enableHiveSupport">enableHiveSupport</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/hadoop/">
                                
                                    See all 12 posts  →
                                
                            </a>
                        </footer>
                    </article>
                <script type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
                </script>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/dependency-inversion-principle">
                <div class="post-card-image" style="background-image: url(/assets/built/images/spring/injection.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/dependency-inversion-principle">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Spring</span>
                            
                        
                    

                    <h2 class="post-card-title">DIP(Dependency Inversion Principle),의존관계 역전 원칙</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>의존관계 역전 원칙과 이를 지키기 위한 의존관계 주입(Depdendency Injection, DI)에 대해서 알아봅니다

</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/built/images/GyuhoonK.jpg" alt="GyuhoonK" />
                        
                        <span class="post-card-author">
                            <a href="/author/GyuhoonK/">GyuhoonK</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      4 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/prepared-statement">
                <div class="post-card-image" style="background-image: url(/assets/built/images/database/preparedstatement.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/prepared-statement">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Database</span>
                            
                        
                    

                    <h2 class="post-card-title">prepared statement</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>prepared statement

</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/built/images/GyuhoonK.jpg" alt="GyuhoonK" />
                        
                        <span class="post-card-author">
                            <a href="/author/GyuhoonK/">GyuhoonK</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      3 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://gyuhoonk.github.io/">
            
            <span>Gyuhoon Kim</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Salting in Spark</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Salting+in+Spark&amp;url=https://gyuhoonk.github.iospark-salting"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://gyuhoonk.github.iospark-salting"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://gyuhoonk.github.io/">Gyuhoon Kim</a> &copy; 2025</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyllt/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    
        <div id="subscribe" class="subscribe-overlay">
            <a class="subscribe-overlay-close" href="#"></a>
            <div class="subscribe-overlay-content">
                
                <h1 class="subscribe-overlay-title">Subscribe to Gyuhoon Kim</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest &amp; greatest posts delivered straight to your inbox</p>
                <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

            </div>
        </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-xxxxxxxx-x', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
<script type="text/javascript" async
	src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>

<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
	extensions: ["tex2jax.js"],
	jax: ["input/TeX", "output/HTML-CSS"],
	tex2jax: {
		inlineMath: [ ['$','$'], ["\\(","\\)"] ],
		displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
		processEscapes: true
	},
	"HTML-CSS": { availableFonts: ["TeX"] }
});
</script>
    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->
    <!-- math LaTex-->
    
</body>
</html>
