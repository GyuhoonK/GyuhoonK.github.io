<!DOCTYPE html>
<html>
<head>
    
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Running Models in Parallel with dbt-trino</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    </script>
<meta name="description" content="Data Engineering" />
    <link rel="shortcut icon" href="https://gyuhoonk.github.io/assets/built/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://gyuhoonk.github.io/dbt-trino-temp-view" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Gyuhoon Kim" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Running Models in Parallel with dbt-trino" />
    <meta property="og:description" content="dbt trino에서 파티션이 있는 모델을 병렬 실행하기 위한 매크로 수정 방법 dbt-trino dbt-trino를 이용하면, dbt를 통해 trino 쿼리를 실행할 수 있습니다. 파티션 단위 모델링 일반적으로 dbt-trino를 사용할 때, 모델 작성을 파티션 단위로 하게 됩니다. 예를 들면 아래와 같습니다. -- models/model_A SELECT column_a , column_b , column_c , date '{{ var("date")" />
    <meta property="og:url" content="https://gyuhoonk.github.io/dbt-trino-temp-view" />
    <meta property="og:image" content="https://gyuhoonk.github.io/assets/built/images/dbt/dbt-logo.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2024-06-09T22:30:00+09:00" />
    <meta property="article:modified_time" content="2024-06-09T22:30:00+09:00" />
    <meta property="article:tag" content="Dbt" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Running Models in Parallel with dbt-trino" />
    <meta name="twitter:description" content="dbt trino에서 파티션이 있는 모델을 병렬 실행하기 위한 매크로 수정 방법 dbt-trino dbt-trino를 이용하면, dbt를 통해 trino 쿼리를 실행할 수 있습니다. 파티션 단위 모델링 일반적으로 dbt-trino를 사용할 때, 모델 작성을 파티션 단위로 하게 됩니다. 예를 들면 아래와 같습니다. -- models/model_A SELECT column_a , column_b , column_c , date '{{ var("date")" />
    <meta name="twitter:url" content="https://gyuhoonk.github.io/" />
    <meta name="twitter:image" content="https://gyuhoonk.github.io/assets/built/images/dbt/dbt-logo.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Gyuhoon Kim" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Dbt" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Gyuhoon Kim",
        "logo": "https://gyuhoonk.github.io/"
    },
    "url": "https://gyuhoonk.github.io/dbt-trino-temp-view",
    "image": {
        "@type": "ImageObject",
        "url": "https://gyuhoonk.github.io/assets/built/images/dbt/dbt-logo.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://gyuhoonk.github.io/dbt-trino-temp-view"
    },
    "description": "dbt trino에서 파티션이 있는 모델을 병렬 실행하기 위한 매크로 수정 방법 dbt-trino dbt-trino를 이용하면, dbt를 통해 trino 쿼리를 실행할 수 있습니다. 파티션 단위 모델링 일반적으로 dbt-trino를 사용할 때, 모델 작성을 파티션 단위로 하게 됩니다. 예를 들면 아래와 같습니다. -- models/model_A SELECT column_a , column_b , column_c , date '{{ var("date")"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Running Models in Parallel with dbt-trino" href="/feed.xml" />

    
</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://gyuhoonk.github.io/">Gyuhoon Kim</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem">
        <a href="/about/">About</a>
    </li>
    <li class="nav-python" role="menuitem">
        <a href="/tag/python/">python</a>
    </li>
    <li class="nav-scala" role="menuitem">
        <a href="/tag/scala/">scala</a>
    </li>
    <li class="nav-hadoop" role="menuitem">
        <a href="/tag/hadoop/">hadoop</a>
    </li>
    <li class="nav-database" role="menuitem">
        <a href="/tag/database/">database</a>
    </li>
    <li class="nav-database" role="menuitem">
        <a href="/tag/kubernetes/">kubernetes</a>
    </li>
    <li class="nav-archive" role="menuitem">
        <a href="/archive.html">All Posts</a>
    </li>
    <li class="nav-archive" role="menuitem">
        <a href="/author_archive.html">Tag</a>
    </li>
</ul>
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
        </div>
        
            <a class="subscribe-button" href="#subscribe">Subscribe</a>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-dbt post tag-dbt ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime=" 9 June 2024"> 9 June 2024</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/dbt/'>DBT</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Running Models in Parallel with dbt-trino</h1>
            </header>

            <!-- 
            <figure class="post-full-image" style="background-image: url(/assets/built/images/dbt/dbt-logo.jpg)">
            </figure>
             -->

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>dbt trino에서 파티션이 있는 모델을 병렬 실행하기 위한 매크로 수정 방법</p>

<h3 id="dbt-trino">dbt-trino</h3>

<p>dbt-trino를 이용하면, dbt를 통해 trino 쿼리를 실행할 수 있습니다.</p>

<h3 id="파티션-단위-모델링">파티션 단위 모델링</h3>

<p>일반적으로 dbt-trino를 사용할 때, 모델 작성을 파티션 단위로 하게 됩니다. 예를 들면 아래와 같습니다.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">-- models/model_A</span>
<span class="k">SELECT</span> <span class="n">column_a</span>
    <span class="p">,</span> <span class="n">column_b</span>
    <span class="p">,</span> <span class="n">column_c</span>
    <span class="p">,</span> <span class="nb">date</span> <span class="s1">'{{ var("date") }}'</span> <span class="k">AS</span> <span class="n">partition_date</span>
<span class="k">FROM</span> <span class="err">{{</span> <span class="k">ref</span><span class="p">(</span><span class="nv">"model_B"</span> <span class="p">)</span><span class="err">}}</span>
<span class="k">WHERE</span> <span class="n">partition_date</span> <span class="o">=</span> <span class="nb">date</span> <span class="s1">'{{ var("date") }}'</span>

</code></pre></div></div>

<p>위 model_A는 model_B로부터 특정 파티션(logical_date)만을 참조하여 model_A에 적재합니다. 
1개 파티션만을 참조하고, 1개 파티션에만 적재합니다.</p>

<h3 id="동시-실행-불가능">동시 실행 불가능</h3>

<p>dbt-trino에서는 위와 같이 파티션 단위의 모델을 작성한 경우 여러 개의 파티션에 대해서 동시에 모델 적재(dbt run/build)를 실행할 수 없습니다. 
이는 dbt-trino가 view를 이용하여 insert를 실행하기 때문입니다.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- dbt를 실행하면, dbt-trino는 먼저 적재하려는 데이터에 대응하는 view를 생성한다</span>
<span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="k">view</span>
    <span class="nv">"hive"</span><span class="p">.</span><span class="nv">"default"</span><span class="p">.</span><span class="nv">"model_A_dbt_tmp"</span>
  <span class="k">security</span> <span class="k">definer</span>
  <span class="k">as</span>
<span class="k">SELECT</span> <span class="n">column_a</span>
    <span class="p">,</span> <span class="n">column_b</span>
    <span class="p">,</span> <span class="n">column_c</span>
    <span class="p">,</span> <span class="nb">date</span> <span class="s1">'2024-06-01'</span> <span class="k">AS</span> <span class="n">partition_date</span>
<span class="k">FROM</span> <span class="nv">"hive"</span><span class="p">.</span><span class="nv">"default"</span><span class="p">.</span><span class="nv">"model_B"</span>
<span class="k">WHERE</span> <span class="n">partition_date</span> <span class="o">=</span> <span class="nb">date</span> <span class="s1">'2024-06-01'</span>
<span class="p">;</span>

<span class="c1">-- 위에서 생성된 view를 적재 대상 테이블에 insert한다</span>
<span class="k">insert</span> <span class="k">into</span> <span class="nv">"hive"</span><span class="p">.</span><span class="nv">"default"</span><span class="p">.</span><span class="nv">"model_A"</span> <span class="p">(</span><span class="nv">"column_a"</span><span class="p">,</span> <span class="nv">"column_b"</span><span class="p">,</span> <span class="nv">"column_c"</span><span class="p">,</span> <span class="nv">"partition_date"</span><span class="p">)</span>
    <span class="p">(</span>
        <span class="k">select</span> <span class="nv">"column_a"</span><span class="p">,</span> <span class="nv">"column_b"</span><span class="p">,</span> <span class="nv">"column_c"</span><span class="p">,</span> <span class="nv">"partition_date"</span>
        <span class="k">from</span> <span class="nv">"hive"</span><span class="p">.</span><span class="nv">"default"</span><span class="p">.</span><span class="nv">"model_A_dbt_tmp"</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>dbt-trino는 적재 대상 테이블(<code class="language-plaintext highlighter-rouge">model_A</code>)에 적재하기 위한 데이터를 view(<code class="language-plaintext highlighter-rouge">model_A_dbt_tmp</code>)로 먼저 생성하고, 
해당 view를 테이블에 insert into로 적재합니다.</p>

<p>이 과정에서 중간에 사용되는 view의 이름이 <code class="language-plaintext highlighter-rouge">{table_name}_dbt_tmp</code>로 고정되어있습니다. 이 부분이 문제가 됩니다.</p>

<p>만약 아래처럼 3개 모델을 동시에 실행한다고 가정해보겠습니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dbt run -m model_A --vars "{'date': '2024-06-01'}"
dbt run -m model_A --vars "{'date': '2024-06-02'}"
dbt run -m model_A --vars "{'date': '2024-06-03'}"

# 3개의 커맨드가 모두 동일한 view_name을 사용함 ("hive"."default"."model_A__dbt_tmp")
</code></pre></div></div>

<p>동시에 위 3개 명령을 실행하게 되면, <code class="language-plaintext highlighter-rouge">model_A_dbt_tmp</code> view는 <code class="language-plaintext highlighter-rouge">create or replace</code>에 의해 마지막 실행에 해당하는 데이터(<code class="language-plaintext highlighter-rouge">2024-06-03</code>)만 담고 있게 됩니다. <br />
따라서 <code class="language-plaintext highlighter-rouge">insert into</code>가 실행되어도, <code class="language-plaintext highlighter-rouge">2024-06-01, 2024-06-02</code>에 해당하는 데이터에 대응하는 view가 없기 때문에 해당 파티션은 적재할 수 없습니다.</p>

<h3 id="해결책-temp-view-이름을-변경하자">해결책: temp view 이름을 변경하자</h3>
<p>중간에 생성하는 temp view를 파티션 의존적으로 변경하면 이를 해결할 수 있습니다.</p>

<p>dbt-core v1.7.5 기준으로, temp view 이름을 생성하는 부분은 아래와 같습니다.(<a href="https://github.com/dbt-labs/dbt-core/blob/v1.7.5/core/dbt/include/global_project/macros/materializations/models/incremental/incremental.sql#L2">incremental(dbt-core)</a>)</p>

<div class="language-jinja highlighter-rouge"><div class="highlight"><pre class="highlight"><code>macros/materializations/incremental.sql

<span class="cp">{%</span> <span class="nv">materialization</span> <span class="nv">incremental</span><span class="p">,</span> <span class="nv">default</span> <span class="o">-</span><span class="cp">%}</span>

  -- relations
  <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">existing_relation</span> <span class="o">=</span> <span class="nv">load_cached_relation</span><span class="p">(</span><span class="nv">this</span><span class="p">)</span> <span class="o">-</span><span class="cp">%}</span>
  <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">target_relation</span> <span class="o">=</span> <span class="nv">this.incorporate</span><span class="p">(</span><span class="nv">type</span><span class="o">=</span><span class="s1">'table'</span><span class="p">)</span> <span class="o">-</span><span class="cp">%}</span>
  <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">temp_relation</span> <span class="o">=</span> <span class="nv">make_temp_relation</span><span class="p">(</span><span class="nv">target_relation</span><span class="p">)</span><span class="o">-</span><span class="cp">%}</span>
  <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">intermediate_relation</span> <span class="o">=</span> <span class="nv">make_intermediate_relation</span><span class="p">(</span><span class="nv">target_relation</span><span class="p">)</span><span class="o">-</span><span class="cp">%}</span>
  <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">backup_relation_type</span> <span class="o">=</span> <span class="s1">'table'</span> <span class="k">if</span> <span class="nv">existing_relation</span> <span class="ow">is</span> <span class="kp">none</span> <span class="k">else</span> <span class="nv">existing_relation.type</span> <span class="o">-</span><span class="cp">%}</span>
  <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">backup_relation</span> <span class="o">=</span> <span class="nv">make_backup_relation</span><span class="p">(</span><span class="nv">target_relation</span><span class="p">,</span> <span class="nv">backup_relation_type</span><span class="p">)</span> <span class="o">-</span><span class="cp">%}</span>

</code></pre></div></div>

<p>dbt-trino v1.7.0에서는 아래와 같은 매크로로 오버라이딩되어있습니다.(<a href="https://github.com/starburstdata/dbt-trino/blob/v1.7.1/dbt/include/trino/macros/materializations/incremental.sql#L21">incremental(dbt-trino)</a>)</p>

<div class="language-jinja highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">{%</span> <span class="nv">materialization</span> <span class="nv">incremental</span><span class="p">,</span> <span class="nv">adapter</span><span class="o">=</span><span class="s1">'trino'</span><span class="p">,</span> <span class="nv">supported_languages</span><span class="o">=</span><span class="p">[</span><span class="s1">'sql'</span><span class="p">]</span> <span class="o">-</span><span class="cp">%}</span>
  <span class="c">{#-- Set vars --#}</span>
  <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">full_refresh_mode</span> <span class="o">=</span> <span class="p">(</span><span class="nv">should_full_refresh</span><span class="p">())</span> <span class="o">-</span><span class="cp">%}</span>
  <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">language</span> <span class="o">=</span> <span class="nv">model</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]</span> <span class="o">-</span><span class="cp">%}</span>
  <span class="cp">{%</span> <span class="k">set</span> <span class="nv">target_relation</span> <span class="o">=</span> <span class="nv">this.incorporate</span><span class="p">(</span><span class="nv">type</span><span class="o">=</span><span class="s1">'table'</span><span class="p">)</span> <span class="cp">%}</span>
  <span class="cp">{%</span> <span class="k">set</span> <span class="nv">existing_relation</span> <span class="o">=</span> <span class="nv">load_relation</span><span class="p">(</span><span class="nv">this</span><span class="p">)</span> <span class="cp">%}</span>

  <span class="c">{#-- The temp relation will be a view (faster) or temp table, depending on upsert/merge strategy --#}</span>
  <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">unique_key</span> <span class="o">=</span> <span class="nv">config.get</span><span class="p">(</span><span class="s1">'unique_key'</span><span class="p">)</span> <span class="o">-</span><span class="cp">%}</span>
  <span class="cp">{%</span> <span class="k">set</span> <span class="nv">incremental_strategy</span> <span class="o">=</span> <span class="nv">config.get</span><span class="p">(</span><span class="s1">'incremental_strategy'</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">'default'</span> <span class="cp">%}</span>
  <span class="cp">{%</span> <span class="k">set</span> <span class="nv">tmp_relation_type</span> <span class="o">=</span> <span class="nv">get_incremental_tmp_relation_type</span><span class="p">(</span><span class="nv">incremental_strategy</span><span class="p">,</span> <span class="nv">unique_key</span><span class="p">,</span> <span class="nv">language</span><span class="p">)</span> <span class="cp">%}</span>
  <span class="cp">{%</span> <span class="k">set</span> <span class="nv">tmp_relation</span> <span class="o">=</span> <span class="nv">make_temp_relation</span><span class="p">(</span><span class="nv">this</span><span class="p">)</span><span class="err">.</span><span class="nv">incorporate</span><span class="p">(</span><span class="nv">type</span><span class="o">=</span><span class="nv">tmp_relation_type</span><span class="p">)</span> <span class="cp">%}</span>

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">tmp_relation</code>이 view name으로 사용되는데, <code class="language-plaintext highlighter-rouge">make_temp_relation</code>은 아래와 같습니다.(<a href="https://github.com/dbt-labs/dbt-core/blob/5f5ddd27ac9864b820d985ea7553d26db8f52fd4/core/dbt/include/global_project/macros/adapters/relation.sql#L9">make_temp_relation</a>)</p>

<div class="language-jinja highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-- dbt-core

<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">make_temp_relation</span><span class="p">(</span><span class="nv">base_relation</span><span class="p">,</span> <span class="nv">suffix</span><span class="o">=</span><span class="s1">'__dbt_tmp'</span><span class="p">)</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">return</span><span class="p">(</span><span class="nv">adapter.dispatch</span><span class="p">(</span><span class="s1">'make_temp_relation'</span><span class="p">,</span> <span class="s1">'dbt'</span><span class="p">)(</span><span class="nv">base_relation</span><span class="p">,</span> <span class="nv">suffix</span><span class="p">))</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endmacro</span> <span class="cp">%}</span>


</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">adapter</code>라는 처음보는 객체가 등장했습니다. <a href="https://docs.getdbt.com/reference/dbt-jinja-functions/adapter">adapter에 대한 설명</a>을 읽어보면, 
adapter는 dbt가 접근하는 데이터베이스에 따라 동작을 다르게 하기 위해 만들어진 인터페이스입니다. 
여기서 <code class="language-plaintext highlighter-rouge">adapter.disaptch</code>는 입력받은 macro_name(<code class="language-plaintext highlighter-rouge">make_temp_relation</code>)을 실행할 때, 현재 dbt가 접근 중인 데이터베이스에 해당하는 매크로를 반환해줍니다.
trino용 매크로는 <code class="language-plaintext highlighter-rouge">trino__make_temp_relation</code>으로 작성되어 있어야하고, 만약 작성된 매크로가 없다면 <code class="language-plaintext highlighter-rouge">default__make_temp_relation</code>를 반환합니다.</p>

<p>trino__make_temp_relation는 존재하지 않으므로, default__make_temp_relation를 사용합니다.(<a href="https://github.com/dbt-labs/dbt-core/blob/v1.7.5/core/dbt/include/global_project/macros/adapters/relation.sql#L13">default__make_temp_relation</a>)</p>

<div class="language-jinja highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">default__make_temp_relation</span><span class="p">(</span><span class="nv">base_relation</span><span class="p">,</span> <span class="nv">suffix</span><span class="p">)</span> <span class="cp">%}</span>
    <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">temp_identifier</span> <span class="o">=</span> <span class="nv">base_relation.identifier</span> <span class="err">~</span> <span class="nv">suffix</span> <span class="o">-</span><span class="cp">%}</span>
    <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">temp_relation</span> <span class="o">=</span> <span class="nv">base_relation.incorporate</span><span class="p">(</span>
                                <span class="nv">path</span><span class="o">=</span><span class="err">{</span><span class="s2">"identifier"</span><span class="err">:</span> <span class="nv">temp_identifier</span><span class="err">}</span><span class="p">)</span> <span class="o">-</span><span class="cp">%}</span>

    <span class="cp">{{</span> <span class="nv">return</span><span class="p">(</span><span class="nv">temp_relation</span><span class="p">)</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endmacro</span> <span class="cp">%}</span>

</code></pre></div></div>

<p>결론적으로, 적재를 위해 생성되는 view name을 결정하는 부분은 make_temp_relation의 suffix입니다. 
suffix가 기본값이 <code class="language-plaintext highlighter-rouge">__dbt_tmp</code>이기 때문에 항상 같은 view name을 생성합니다. 
그렇다면 <code class="language-plaintext highlighter-rouge">make_temp_realtion</code>를 오버라이딩해보겠습니다. dispatch에 의해 default 매크로를 호출할 때 사용하는 suffix를 수정합니다.</p>

<div class="language-jinja highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">make_temp_relation</span><span class="p">(</span><span class="nv">base_relation</span><span class="p">,</span> <span class="nv">suffix</span><span class="o">=</span><span class="s1">'__dbt_tmp'</span><span class="p">)</span> <span class="cp">%}</span>
    <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">ymd</span> <span class="o">=</span> <span class="nv">var</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span> <span class="o">| </span><span class="nf">replace</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="o">-</span><span class="cp">%}</span> <span class="c">{# date에서 -를 제거함 #}</span>
    <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">suffix</span> <span class="o">=</span> <span class="nv">suffix</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="nv">ymd</span> <span class="o">-</span><span class="cp">%}</span> <span class="c">{# 기존 suffix에 ymd를 붙임 #}</span>
  <span class="cp">{{</span> <span class="nv">return</span><span class="p">(</span><span class="nv">adapter.dispatch</span><span class="p">(</span><span class="s1">'make_temp_relation'</span><span class="p">,</span> <span class="s1">'dbt'</span><span class="p">)(</span><span class="nv">base_relation</span><span class="p">,</span> <span class="nv">suffix</span><span class="p">))</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endmacro</span> <span class="cp">%}</span>

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">make_temp_relation</code>에서 suffix로 전달되는 값을 변경했습니다. 기존에는 <code class="language-plaintext highlighter-rouge">__dbt_tmp</code>로 고정되어있었으나, 위 매크로에서는 dbt 실행 시마다 입력되는 <code class="language-plaintext highlighter-rouge">var('date')</code>에 따라 suffix 값이 변경됩니다.</p>

<p>따라서 입력받은 vars 값에 따라 각기 다른 temp view를 생성하게 됩니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dbt run -m model_A --vars "{'date': '2024-06-01'}"
# view_name: "hive"."default"."model_A__dbt_tmp_20240601"
---
dbt run -m model_A --vars "{'date': '2024-06-02'}"
# view_name: "hive"."default"."model_A__dbt_tmp_20240602"
---
dbt run -m model_A --vars "{'date': '2024-06-03'}"
# view_name: "hive"."default"."model_A__dbt_tmp_20240603"
</code></pre></div></div>

<p>1개 모델 테이블에 대해서 여러개의 dbt run을 실행해도 각각 서로 다른 view를 생성하므로 병렬 실행이 가능해집니다.</p>

<p>위에서 정리한 macro들간의 관계를 정리하면 아래 그림과 같습니다.</p>

<p><img src="../../assets/built/images/dbt/tmp_relation.png" alt="tmp_relation" /></p>

<p>[참고]</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            <!-- 
                <section class="subscribe-form">
                    <h3 class="subscribe-form-title">Subscribe to Gyuhoon Kim</h3>
                    <p>Get the latest posts delivered right to your inbox</p>
                    <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

                </section>
             -->

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/built/images/GyuhoonK.jpg" alt="GyuhoonK" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/GyuhoonK">GyuhoonK</a></h4>
                                
                                    <p>Read <a href="/author/GyuhoonK">more posts</a> by this author.</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/GyuhoonK">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            <!--  -->
            <!-- utteranc setting -->
            <script src="https://utteranc.es/client.js"
                    repo="GyuhoonK/blog-comments"
                    issue-term="pathname"
                    theme="github-light"
                    crossorigin="anonymous"
                    async>
            </script>

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/variables">
                <div class="post-card-image" style="background-image: url(/assets/built/images/airflow/airflow.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/variables">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Airflow</span>
                            
                        
                    

                    <h2 class="post-card-title">Variables & Dag Parsing</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>Variables 사용 방법을 알아보고, Dag Parsing에서 그 이유를 살펴봅니다.

</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/built/images/GyuhoonK.jpg" alt="GyuhoonK" />
                        
                        <span class="post-card-author">
                            <a href="/author/GyuhoonK/">GyuhoonK</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/depdendency-injection">
                <div class="post-card-image" style="background-image: url(/assets/built/images/spring/spring-3-logo.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/depdendency-injection">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Spring</span>
                            
                        
                    

                    <h2 class="post-card-title">Spring Dependency Injection, Component Scan</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>Spring의 의존관계 주입 방법과 Component Scan에 대해서 알아봅니다

</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/built/images/GyuhoonK.jpg" alt="GyuhoonK" />
                        
                        <span class="post-card-author">
                            <a href="/author/GyuhoonK/">GyuhoonK</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      2 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://gyuhoonk.github.io/">
            
            <span>Gyuhoon Kim</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Running Models in Parallel with dbt-trino</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Running+Models+in+Parallel+with+dbt-trino&amp;url=https://gyuhoonk.github.iodbt-trino-temp-view"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://gyuhoonk.github.iodbt-trino-temp-view"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://gyuhoonk.github.io/">Gyuhoon Kim</a> &copy; 2024</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyllt/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    
        <div id="subscribe" class="subscribe-overlay">
            <a class="subscribe-overlay-close" href="#"></a>
            <div class="subscribe-overlay-content">
                
                <h1 class="subscribe-overlay-title">Subscribe to Gyuhoon Kim</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest &amp; greatest posts delivered straight to your inbox</p>
                <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

            </div>
        </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-xxxxxxxx-x', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
<script type="text/javascript" async
	src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>

<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
	extensions: ["tex2jax.js"],
	jax: ["input/TeX", "output/HTML-CSS"],
	tex2jax: {
		inlineMath: [ ['$','$'], ["\\(","\\)"] ],
		displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
		processEscapes: true
	},
	"HTML-CSS": { availableFonts: ["TeX"] }
});
</script>
    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->
    <!-- math LaTex-->
    
</body>
</html>
